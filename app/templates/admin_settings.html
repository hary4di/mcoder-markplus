{% extends "base.html" %}

{% block title %}Admin Settings - M-Code Pro{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="bi bi-gear-fill"></i> System Settings</h2>
                    <p class="text-muted">Configure AI classification, prompts, and system behavior</p>
                </div>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="openai-tab" data-bs-toggle="tab" data-bs-target="#openai" type="button">
                        <i class="bi bi-robot"></i> OpenAI API
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="brevo-tab" data-bs-toggle="tab" data-bs-target="#brevo" type="button">
                        <i class="bi bi-envelope-fill"></i> Brevo Email
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="classification-tab" data-bs-toggle="tab" data-bs-target="#classification" type="button">
                        <i class="bi bi-sliders"></i> Classification
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="parallel-tab" data-bs-toggle="tab" data-bs-target="#parallel" type="button">
                        <i class="bi bi-lightning-charge-fill"></i> Parallel Processing
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="prompts-tab" data-bs-toggle="tab" data-bs-target="#prompts" type="button">
                        <i class="bi bi-chat-quote-fill"></i> AI Prompts
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="patterns-tab" data-bs-toggle="tab" data-bs-target="#patterns" type="button">
                        <i class="bi bi-exclamation-triangle-fill"></i> Invalid Patterns
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button">
                        <i class="bi bi-info-circle"></i> System Info
                    </button>
                </li>
            </ul>

            <div class="tab-content border border-top-0 p-4 bg-white rounded-bottom shadow-sm" id="settingsTabContent">
                
                <!-- OpenAI API Tab -->
                <div class="tab-pane fade show active" id="openai" role="tabpanel">
                    <h4 class="mb-4"><i class="bi bi-robot text-primary"></i> OpenAI API Configuration</h4>
                    <form method="POST" action="{{ url_for('main.save_settings') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="setting_type" value="openai">
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-4">
                                    <label for="openai_api_key" class="form-label fw-bold">
                                        API Key <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                        <input type="password" class="form-control" id="openai_api_key" name="openai_api_key" 
                                               value="{{ openai_api_key }}" required placeholder="sk-...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('openai_api_key')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> Get your API key from 
                                        <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="openai_model" class="form-label fw-bold">AI Model</label>
                                    <select class="form-select" id="openai_model" name="openai_model">
                                        <option value="gpt-4o-mini" {{ 'selected' if openai_model == 'gpt-4o-mini' else '' }}>
                                            GPT-4o-mini - Recommended (Fast & Economical: ~$0.15/1M tokens)
                                        </option>
                                        <option value="gpt-4o" {{ 'selected' if openai_model == 'gpt-4o' else '' }}>
                                            GPT-4o - More Accurate (Higher Cost: ~$2.50/1M tokens)
                                        </option>
                                        <option value="gpt-4-turbo" {{ 'selected' if openai_model == 'gpt-4-turbo' else '' }}>
                                            GPT-4 Turbo - Legacy Model
                                        </option>
                                    </select>
                                    <div class="form-text">
                                        <i class="bi bi-lightning-charge-fill text-warning"></i> 
                                        GPT-4o-mini recommended untuk production (balance antara cost & accuracy)
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-lightbulb-fill text-warning"></i> Tips</h6>
                                        <ul class="small mb-0">
                                            <li>Never share your API key</li>
                                            <li>Monitor usage at OpenAI dashboard</li>
                                            <li>Set spending limits to avoid overages</li>
                                            <li>GPT-4o-mini cukup untuk most cases</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save"></i> Save OpenAI Settings
                        </button>
                    </form>
                </div>

                <!-- Brevo Email Tab -->
                <div class="tab-pane fade" id="brevo" role="tabpanel">
                    <h4 class="mb-4"><i class="bi bi-envelope-fill text-primary"></i> Brevo Email Configuration</h4>
                    <form method="POST" action="{{ url_for('main.save_settings') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="setting_type" value="brevo">
                        
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle"></i> <strong>What is Brevo?</strong>
                            <p class="mb-0 mt-2">
                                Brevo (formerly SendinBlue) is used to send OTP codes for password reset via email.
                                Get your free API key at <a href="https://app.brevo.com/settings/keys/api" target="_blank">Brevo Dashboard</a>
                            </p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-4">
                                    <label for="brevo_api_key" class="form-label fw-bold">
                                        Brevo API Key <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                        <input type="password" class="form-control" id="brevo_api_key" name="brevo_api_key" 
                                               value="{{ brevo_api_key }}" placeholder="xkeysib-...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('brevo_api_key')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> Get API key from 
                                        <a href="https://app.brevo.com/settings/keys/api" target="_blank">Brevo Dashboard → API Keys</a>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="brevo_sender_email" class="form-label fw-bold">
                                        Sender Email Address <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                        <input type="email" class="form-control" id="brevo_sender_email" name="brevo_sender_email" 
                                               value="{{ brevo_sender_email }}" placeholder="msurvey@markplusinc.com" required>
                                    </div>
                                    <div class="form-text">
                                        <i class="bi bi-exclamation-circle text-warning"></i> 
                                        Email ini harus sudah diverifikasi di Brevo
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="brevo_sender_name" class="form-label fw-bold">
                                        Sender Name
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                                        <input type="text" class="form-control" id="brevo_sender_name" name="brevo_sender_name" 
                                               value="{{ brevo_sender_name }}" placeholder="M-Coder Platform">
                                    </div>
                                    <div class="form-text">
                                        Nama yang muncul sebagai pengirim email
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <button type="button" class="btn btn-outline-primary" onclick="testBrevoConnection()">
                                        <i class="bi bi-check-circle"></i> Test Connection
                                    </button>
                                    <span id="brevo_test_result" class="ms-3"></span>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-lightbulb-fill text-warning"></i> Setup Guide</h6>
                                        <ol class="small mb-0">
                                            <li>Create free account at <a href="https://www.brevo.com" target="_blank">brevo.com</a></li>
                                            <li>Verify your sender email address</li>
                                            <li>Generate API key from dashboard</li>
                                            <li>Paste API key here</li>
                                            <li>Click "Test Connection"</li>
                                        </ol>
                                    </div>
                                </div>

                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-info-circle text-primary"></i> Usage</h6>
                                        <p class="small mb-0">
                                            Brevo free plan includes <strong>300 emails/day</strong>. 
                                            Perfect for OTP verification codes.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save"></i> Save Brevo Settings
                        </button>
                    </form>
                </div>

                <!-- Classification Tab -->
                <div class="tab-pane fade" id="classification" role="tabpanel">
                    <h4 class="mb-4"><i class="bi bi-sliders text-info"></i> Classification Settings</h4>
                    <form method="POST" action="{{ url_for('main.save_settings') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="setting_type" value="classification">
                        
                        <!-- Basic Settings -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-gear"></i> Basic Configuration</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="invalid_category" class="form-label fw-bold">Invalid Category Label</label>
                                        <input type="text" class="form-control" id="invalid_category" name="invalid_category" 
                                               value="{{ invalid_category }}" required>
                                        <div class="form-text">Label untuk responses yang invalid</div>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="invalid_code" class="form-label fw-bold">Invalid Response Code</label>
                                        <input type="number" class="form-control" id="invalid_code" name="invalid_code" 
                                               value="{{ invalid_code }}" required min="1">
                                        <div class="form-text">Numeric code (default: 99)</div>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="max_categories" class="form-label fw-bold">Max Categories</label>
                                        <input type="number" class="form-control" id="max_categories" name="max_categories" 
                                               value="{{ max_categories }}" required min="5" max="20">
                                        <div class="form-text">Default max per variable (5-20)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Multi-Label Settings -->
                        <div class="card mb-4 border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-tags-fill"></i> Multi-Label Classification</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-4">
                                    <strong><i class="bi bi-info-circle"></i> What is Multi-Label?</strong>
                                    <p class="mb-0 mt-2">
                                        Allow responses to be classified into <strong>multiple categories</strong> simultaneously.
                                        <br>Example: "Harga mahal dan antrian panjang" → Codes "1 3" (Harga + Waktu Tunggu)
                                    </p>
                                </div>

                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="enable_multi_label" class="form-label fw-bold">
                                            Enable Multi-Label <i class="bi bi-question-circle" data-bs-toggle="tooltip" 
                                            title="When enabled, responses can have multiple category codes"></i>
                                        </label>
                                        <select class="form-select form-select-lg" id="enable_multi_label" name="enable_multi_label">
                                            <option value="true" {{ 'selected' if enable_multi_label == 'true' else '' }}>
                                                ✓ Enabled (Recommended)
                                            </option>
                                            <option value="false" {{ 'selected' if enable_multi_label == 'false' else '' }}>
                                                ✗ Disabled
                                            </option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <label for="min_category_confidence" class="form-label fw-bold">
                                            Min Confidence 
                                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" 
                                            title="Only include categories with confidence ≥ this value"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="min_category_confidence" 
                                                   name="min_category_confidence" value="{{ min_category_confidence }}" 
                                                   step="0.05" min="0.3" max="0.9" required>
                                            <span class="input-group-text">
                                                <span id="conf_display">{{ (min_category_confidence|float * 100)|int }}%</span>
                                            </span>
                                        </div>
                                        <div class="form-text">Range: 0.30 - 0.90</div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <label for="max_categories_per_response" class="form-label fw-bold">
                                            Max Categories/Response
                                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" 
                                            title="Maximum number of categories per single response"></i>
                                        </label>
                                        <input type="number" class="form-control" id="max_categories_per_response" 
                                               name="max_categories_per_response" value="{{ max_categories_per_response }}" 
                                               min="1" max="5" required>
                                        <div class="form-text">Limit: 1-5 categories</div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <label for="single_category_threshold" class="form-label fw-bold">
                                            Clear Winner Threshold
                                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" 
                                            title="If any category reaches this confidence, use ONLY that category"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="single_category_threshold" 
                                                   name="single_category_threshold" value="{{ single_category_threshold }}" 
                                                   step="0.05" min="0.7" max="1.0" required>
                                            <span class="input-group-text">
                                                <span id="thresh_display">{{ (single_category_threshold|float * 100)|int }}%</span>
                                            </span>
                                        </div>
                                        <div class="form-text">Range: 0.70 - 1.00</div>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title"><i class="bi bi-diagram-3-fill"></i> How It Works</h6>
                                                <ol class="mb-0 small">
                                                    <li><strong>AI analyzes response</strong> semantically to detect ALL themes mentioned</li>
                                                    <li><strong>Filters by confidence:</strong> Only categories ≥ <span class="badge bg-info">{{ (min_category_confidence|float * 100)|int }}%</span></li>
                                                    <li><strong>Limits per response:</strong> Max <span class="badge bg-warning text-dark">{{ max_categories_per_response }}</span> categories</li>
                                                    <li><strong>Clear winner rule:</strong> If any category ≥ <span class="badge bg-success">{{ (single_category_threshold|float * 100)|int }}%</span>, use only that one</li>
                                                    <li><strong>Output format:</strong> Space-separated codes (e.g., "1 3 5") for Kobo compatibility</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-info btn-lg text-white">
                            <i class="bi bi-save"></i> Save Classification Settings
                        </button>
                    </form>
                </div>

                <!-- Parallel Processing Tab (NEW!) -->
                <div class="tab-pane fade" id="parallel" role="tabpanel">
                    <h4 class="mb-4"><i class="bi bi-lightning-charge-fill text-warning"></i> Parallel Processing Configuration</h4>
                    <form method="POST" action="{{ url_for('main.save_settings') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="setting_type" value="parallel">
                        
                        <!-- Performance Alert -->
                        <div class="alert alert-success mb-4">
                            <h5 class="alert-heading"><i class="bi bi-rocket-takeoff-fill"></i> Speed Up Your Classification!</h5>
                            <p class="mb-2">
                                Parallel processing memungkinkan <strong>multiple workers</strong> untuk memproses batches <strong>secara bersamaan</strong>.
                                Mirip dengan worker robots di Google BigQuery.
                            </p>
                            <hr>
                            <p class="mb-0">
                                <strong>Example Performance:</strong> 2,482 responses → Sequential: 17 menit | Parallel (5 workers): <span class="badge bg-success">3-5 menit</span> 
                                <strong>⚡ 3-5x FASTER!</strong>
                            </p>
                        </div>
                        
                        <div class="row">
                            <!-- Left Column: Settings -->
                            <div class="col-md-8">
                                <!-- Enable/Disable -->
                                <div class="card mb-4 border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="bi bi-toggle-on"></i> Enable Parallel Processing</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" role="switch" 
                                                   id="enable_parallel_processing" name="enable_parallel_processing" 
                                                   value="true" {{ 'checked' if enable_parallel_processing == 'true' else '' }}
                                                   style="width: 3em; height: 1.5em;">
                                            <label class="form-check-label ms-2 fs-5" for="enable_parallel_processing">
                                                <strong>{{ 'Parallel Mode ENABLED ⚡' if enable_parallel_processing == 'true' else 'Sequential Mode (Slower)' }}</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mb-0">
                                            <i class="bi bi-info-circle"></i> 
                                            System will auto-select mode based on dataset size (≥100 responses → parallel)
                                        </p>
                                    </div>
                                </div>

                                <!-- Worker Configuration -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="bi bi-people-fill"></i> Worker Configuration</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="parallel_max_workers" class="form-label fw-bold">
                                                    Number of Workers (Robots)
                                                    <i class="bi bi-question-circle" data-bs-toggle="tooltip" 
                                                    title="More workers = faster, but higher risk of rate limit"></i>
                                                </label>
                                                <input type="number" class="form-control form-control-lg" 
                                                       id="parallel_max_workers" name="parallel_max_workers" 
                                                       value="{{ parallel_max_workers }}" min="1" max="15" required>
                                                <div class="form-text">
                                                    <strong>Recommended:</strong> 5 workers (balance speed & stability)
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="rate_limit_delay" class="form-label fw-bold">
                                                    Rate Limit Delay (seconds)
                                                    <i class="bi bi-question-circle" data-bs-toggle="tooltip" 
                                                    title="Delay between API requests to prevent throttling"></i>
                                                </label>
                                                <input type="number" class="form-control form-control-lg" 
                                                       id="rate_limit_delay" name="rate_limit_delay" 
                                                       value="{{ rate_limit_delay }}" step="0.01" min="0.01" max="1.0" required>
                                                <div class="form-text">
                                                    <strong>Recommended:</strong> 0.1 seconds
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Preset Configurations -->
                                        <div class="mt-3">
                                            <label class="form-label fw-bold">Quick Presets:</label>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-outline-secondary" 
                                                        onclick="setParallelPreset('conservative')">
                                                    <i class="bi bi-shield-check"></i> Conservative
                                                    <br><small>(3 workers, 0.2s delay)</small>
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" 
                                                        onclick="setParallelPreset('balanced')">
                                                    <i class="bi bi-check-circle-fill"></i> Balanced ✓
                                                    <br><small>(5 workers, 0.1s delay)</small>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" 
                                                        onclick="setParallelPreset('aggressive')">
                                                    <i class="bi bi-lightning-fill"></i> Aggressive
                                                    <br><small>(10 workers, 0.05s delay)</small>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Performance Estimator -->
                                <div class="card bg-light mb-4">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-calculator"></i> Performance Estimator</h6>
                                        <div class="row text-center">
                                            <div class="col-md-4">
                                                <label class="small text-muted">Responses</label>
                                                <input type="number" class="form-control text-center" 
                                                       id="est_responses" value="2482" min="100">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="small text-muted">Sequential Time</label>
                                                <div class="fs-4 text-danger" id="seq_time">17 min</div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="small text-muted">Parallel Time</label>
                                                <div class="fs-4 text-success" id="par_time">3-5 min</div>
                                            </div>
                                        </div>
                                        <div class="text-center mt-3">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="calculateEstimate()">
                                                <i class="bi bi-calculator-fill"></i> Calculate
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Info & Tips -->
                            <div class="col-md-4">
                                <!-- Configuration Guide -->
                                <div class="card mb-3 border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="bi bi-bookmark-star-fill"></i> Configuration Guide</h6>
                                    </div>
                                    <div class="card-body">
                                        <h6 class="text-success"><i class="bi bi-shield-check"></i> Conservative (Safe)</h6>
                                        <ul class="small mb-3">
                                            <li>Workers: 3</li>
                                            <li>Delay: 0.2s</li>
                                            <li>Speedup: 2-3x</li>
                                            <li>Best for: First-time users, unstable network</li>
                                        </ul>

                                        <h6 class="text-primary"><i class="bi bi-check-circle-fill"></i> Balanced (Recommended)</h6>
                                        <ul class="small mb-3">
                                            <li>Workers: 5</li>
                                            <li>Delay: 0.1s</li>
                                            <li>Speedup: 3-5x</li>
                                            <li>Best for: Production use</li>
                                        </ul>

                                        <h6 class="text-danger"><i class="bi bi-lightning-fill"></i> Aggressive (Fast)</h6>
                                        <ul class="small mb-3">
                                            <li>Workers: 10</li>
                                            <li>Delay: 0.05s</li>
                                            <li>Speedup: 6-8x</li>
                                            <li>Best for: Large datasets, high OpenAI tier</li>
                                            <li><strong>⚠️ Risk:</strong> May hit rate limits!</li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- OpenAI Rate Limits -->
                                <div class="card border-warning mb-3">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Rate Limits</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="small mb-2"><strong>OpenAI Tier Limits:</strong></p>
                                        <ul class="small mb-0">
                                            <li><strong>Free/Tier 1:</strong> Use ≤3 workers</li>
                                            <li><strong>Tier 2:</strong> Safe up to 5 workers ✓</li>
                                            <li><strong>Tier 3+:</strong> Can use 10+ workers</li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Tips -->
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-lightbulb-fill text-warning"></i> Best Practices</h6>
                                        <ul class="small mb-0">
                                            <li>Start with <strong>Balanced</strong> preset</li>
                                            <li>Monitor for rate limit errors in logs</li>
                                            <li>If errors occur → reduce workers</li>
                                            <li>If no errors → can increase workers</li>
                                            <li>Check OpenAI tier at <a href="https://platform.openai.com/account/limits" target="_blank">platform.openai.com</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">
                        <button type="submit" class="btn btn-warning btn-lg text-dark">
                            <i class="bi bi-save"></i> Save Parallel Processing Settings
                        </button>
                    </form>
                </div>

                <!-- AI Prompts Tab -->
                <div class="tab-pane fade" id="prompts" role="tabpanel">
                    <h4 class="mb-4"><i class="bi bi-chat-quote-fill text-success"></i> AI Prompt Configuration</h4>
                    <form method="POST" action="{{ url_for('main.save_settings') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="setting_type" value="ai_prompts">
                        
                        <div class="alert alert-warning mb-4">
                            <i class="bi bi-exclamation-triangle-fill"></i> <strong>Warning:</strong> 
                            Changes to prompts will affect classification results. Test with a small sample before production deployment.
                        </div>

                        <!-- Multi-Label Prompt -->
                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-tags-fill"></i> Multi-Label Prompt
                                </h6>
                                <div>
                                    <span class="badge bg-light text-success">Active when Multi-Label = ON</span>
                                    <button type="button" class="btn btn-sm btn-light ms-2" onclick="document.getElementById('classification-tab').click()" title="Go to Classification tab to toggle ON/OFF">
                                        <i class="bi bi-toggle-on"></i> Toggle in Classification
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control font-monospace" id="prompt_multi_label" name="prompt_multi_label" 
                                          rows="20" style="font-size: 0.85rem;">{{ prompt_multi_label }}</textarea>
                                <div class="mt-3">
                                    <strong><i class="bi bi-code-square"></i> Available Variables:</strong>
                                    <div class="d-flex gap-2 mt-2 flex-wrap">
                                        <code class="bg-light p-2 rounded">{min_category_confidence}</code>
                                        <code class="bg-light p-2 rounded">{max_categories_per_response}</code>
                                        <code class="bg-light p-2 rounded">{single_category_threshold}</code>
                                    </div>
                                    <small class="text-muted mt-2 d-block">
                                        <i class="bi bi-lightbulb"></i> Tips: Be explicit about multi-theme detection. Include concrete examples.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Single-Label Prompt -->
                        <div class="card mb-4 border-secondary">
                            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-tag-fill"></i> Single-Label Prompt
                                </h6>
                                <div>
                                    <span class="badge bg-light text-secondary">Active when Multi-Label = OFF</span>
                                    <button type="button" class="btn btn-sm btn-light ms-2" onclick="document.getElementById('classification-tab').click()" title="Go to Classification tab to toggle ON/OFF">
                                        <i class="bi bi-toggle-off"></i> Toggle in Classification
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control font-monospace" id="prompt_single_label" name="prompt_single_label" 
                                          rows="12" style="font-size: 0.85rem;">{{ prompt_single_label }}</textarea>
                                <div class="mt-3">
                                    <strong><i class="bi bi-code-square"></i> Available Variables:</strong>
                                    <div class="d-flex gap-2 mt-2">
                                        <code class="bg-light p-2 rounded">{min_category_confidence}</code>
                                    </div>
                                    <small class="text-muted mt-2 d-block">
                                        <i class="bi bi-lightbulb"></i> Tips: Instruct AI to select only ONE most relevant category.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-save"></i> Save AI Prompts
                        </button>
                    </form>
                </div>

                <!-- Invalid Patterns Tab -->
                <div class="tab-pane fade" id="patterns" role="tabpanel">
                    <h4 class="mb-4"><i class="bi bi-exclamation-triangle-fill text-warning"></i> Invalid Response Patterns</h4>
                    <form method="POST" action="{{ url_for('main.save_settings') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="setting_type" value="invalid_patterns">
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="alert alert-info mb-4">
                                    <i class="bi bi-info-circle"></i> Responses matching these patterns will be automatically 
                                    coded as <strong>{{ invalid_code }}</strong> ({{ invalid_category }}) without AI analysis.
                                </div>

                                <div class="mb-4">
                                    <label for="invalid_patterns" class="form-label fw-bold">
                                        Pattern List <span class="text-muted">(one per line, case-insensitive)</span>
                                    </label>
                                    <textarea class="form-control font-monospace" id="invalid_patterns" name="invalid_patterns" 
                                              rows="16" style="font-size: 0.9rem;">{{ invalid_patterns }}</textarea>
                                    <div class="form-text">
                                        <i class="bi bi-lightbulb-fill text-warning"></i> 
                                        <strong>Total patterns:</strong> {{ invalid_patterns.split('\n')|length }} patterns configured
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-list-check"></i> Common Patterns</h6>
                                        <ul class="small mb-0">
                                            <li><code>ta</code>, <code>t.a</code></li>
                                            <li><code>tidak ada</code>, <code>tdk ada</code></li>
                                            <li><code>tidak tahu</code>, <code>tdk tau</code></li>
                                            <li><code>n/a</code>, <code>na</code></li>
                                            <li><code>-</code>, <code>--</code>, <code>---</code></li>
                                            <li><code>kosong</code>, <code>empty</code></li>
                                            <li><code>none</code>, <code>nothing</code></li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="card bg-warning bg-opacity-10">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-exclamation-circle"></i> Tips</h6>
                                        <ul class="small mb-0">
                                            <li>Use lowercase for consistency</li>
                                            <li>One pattern per line</li>
                                            <li>Include common typos</li>
                                            <li>Test with sample data first</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">
                        <button type="submit" class="btn btn-warning btn-lg">
                            <i class="bi bi-save"></i> Save Invalid Patterns
                        </button>
                    </form>
                </div>

                <!-- System Info Tab -->
                <div class="tab-pane fade" id="info" role="tabpanel">
                    <h4 class="mb-4"><i class="bi bi-info-circle text-secondary"></i> System Information</h4>
                    
                    <div class="row">
                        <div class="col-md-3 mb-4">
                            <div class="card text-center h-100 border-primary">
                                <div class="card-body">
                                    <i class="bi bi-key fs-1 text-primary mb-3"></i>
                                    <h5 class="card-title">{{ 'Configured' if openai_api_key else 'Not Set' }}</h5>
                                    <p class="card-text text-muted">OpenAI API Key</p>
                                    {% if openai_api_key %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger">Required</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card text-center h-100 border-info">
                                <div class="card-body">
                                    <i class="bi bi-cpu fs-1 text-info mb-3"></i>
                                    <h5 class="card-title">{{ openai_model }}</h5>
                                    <p class="card-text text-muted">AI Model</p>
                                    <span class="badge bg-info">{{ 'Economical' if 'mini' in openai_model else 'Premium' }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card text-center h-100 border-warning">
                                <div class="card-body">
                                    <i class="bi bi-exclamation-octagon fs-1 text-warning mb-3"></i>
                                    <h5 class="card-title">{{ invalid_patterns.split('\n')|length }}</h5>
                                    <p class="card-text text-muted">Invalid Patterns</p>
                                    <span class="badge bg-warning text-dark">Configured</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card text-center h-100 border-success">
                                <div class="card-body">
                                    <i class="bi bi-tags fs-1 text-success mb-3"></i>
                                    <h5 class="card-title">{{ 'Enabled' if enable_multi_label == 'true' else 'Disabled' }}</h5>
                                    <p class="card-text text-muted">Multi-Label Mode</p>
                                    <span class="badge bg-{{ 'success' if enable_multi_label == 'true' else 'secondary' }}">
                                        {{ 'Active' if enable_multi_label == 'true' else 'Inactive' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="bi bi-gear-wide-connected"></i> Current Configuration Summary</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="bi bi-sliders"></i> Classification</h6>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td class="text-muted">Max Categories:</td>
                                            <td><strong>{{ max_categories }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Invalid Code:</td>
                                            <td><strong>{{ invalid_code }}</strong> ({{ invalid_category }})</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success"><i class="bi bi-tags"></i> Multi-Label</h6>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td class="text-muted">Min Confidence:</td>
                                            <td><strong>{{ (min_category_confidence|float * 100)|int }}%</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Max Categories/Response:</td>
                                            <td><strong>{{ max_categories_per_response }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Clear Winner Threshold:</td>
                                            <td><strong>{{ (single_category_threshold|float * 100)|int }}%</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-light border mt-4">
                        <h6><i class="bi bi-shield-check"></i> Security & Best Practices</h6>
                        <ul class="mb-0 small">
                            <li>API keys are encrypted in database</li>
                            <li>Changes are logged for audit trail</li>
                            <li>Test new settings with small sample before production</li>
                            <li>Monitor OpenAI usage to control costs</li>
                            <li>Backup system settings regularly</li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
// Toggle password visibility
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = event.target.closest('button').querySelector('i');
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// Test Brevo connection
async function testBrevoConnection() {
    const resultSpan = document.getElementById('brevo_test_result');
    resultSpan.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Testing...';
    
    try {
        const response = await fetch('{{ url_for("main.test_brevo") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                api_key: document.getElementById('brevo_api_key').value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            resultSpan.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> ' + result.message + '</span>';
        } else {
            resultSpan.innerHTML = '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> ' + result.message + '</span>';
        }
    } catch (error) {
        resultSpan.innerHTML = '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Connection failed</span>';
    }
}

// Live percentage display for confidence inputs
document.getElementById('min_category_confidence')?.addEventListener('input', function() {
    document.getElementById('conf_display').textContent = Math.round(this.value * 100) + '%';
});

document.getElementById('single_category_threshold')?.addEventListener('input', function() {
    document.getElementById('thresh_display').textContent = Math.round(this.value * 100) + '%';
});

// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Parallel Processing Preset Functions
function setParallelPreset(preset) {
    const workersInput = document.getElementById('parallel_max_workers');
    const delayInput = document.getElementById('rate_limit_delay');
    
    if (preset === 'conservative') {
        workersInput.value = 3;
        delayInput.value = 0.2;
    } else if (preset === 'balanced') {
        workersInput.value = 5;
        delayInput.value = 0.1;
    } else if (preset === 'aggressive') {
        workersInput.value = 10;
        delayInput.value = 0.05;
    }
    
    // Flash the inputs to show they changed
    workersInput.classList.add('bg-warning');
    delayInput.classList.add('bg-warning');
    setTimeout(() => {
        workersInput.classList.remove('bg-warning');
        delayInput.classList.remove('bg-warning');
    }, 500);
}

// Performance Calculator
function calculateEstimate() {
    const responses = parseInt(document.getElementById('est_responses').value) || 2482;
    const workers = parseInt(document.getElementById('parallel_max_workers').value) || 5;
    
    // Base calculation: ~146 responses/minute sequential
    const seqRate = 146;
    const seqMinutes = responses / seqRate;
    
    // Parallel speedup: ~workers × 0.85 (85% efficiency)
    const parallelSpeedup = workers * 0.85;
    const parMinutes = seqMinutes / parallelSpeedup;
    
    // Format times
    function formatTime(minutes) {
        if (minutes < 1) return Math.round(minutes * 60) + ' sec';
        if (minutes < 60) return Math.round(minutes) + ' min';
        const hours = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        return hours + 'h ' + mins + 'm';
    }
    
    document.getElementById('seq_time').textContent = formatTime(seqMinutes);
    document.getElementById('par_time').textContent = formatTime(parMinutes);
    
    // Add speedup indicator
    const speedup = (seqMinutes / parMinutes).toFixed(1);
    document.getElementById('par_time').innerHTML = formatTime(parMinutes) + 
        ' <small class="badge bg-success">' + speedup + 'x faster</small>';
}

// Auto-calculate on input change
document.getElementById('est_responses')?.addEventListener('input', calculateEstimate);
document.getElementById('parallel_max_workers')?.addEventListener('input', calculateEstimate);</script>
{% endblock %}