{% extends "base.html" %}

{% block title %}Classification Results - M-Coder Platform{% endblock %}

{% block page_title %}Classification Results{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if results %}
    <!-- Success Alert -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show">
                <i class="bi bi-check-circle-fill"></i>
                <strong>Classification Complete!</strong> 
                All variables have been successfully processed.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    
    <!-- Overall Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="text-primary mb-2">
                        <i class="bi bi-list-check" style="font-size: 2rem;"></i>
                    </div>
                    <h3 class="mb-1">{{ results.summaries|length }}</h3>
                    <p class="text-muted mb-0">
                        {% if results.processing_type == 'semi_open_ended' %}
                            Pairs Processed
                        {% else %}
                            Variables Processed
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="text-success mb-2">
                        <i class="bi bi-tags" style="font-size: 2rem;"></i>
                    </div>
                    <h3 class="mb-1">
                        {% if results.processing_type == 'semi_open_ended' %}
                            {% set total_new = namespace(value=0) %}
                            {% for summary in results.summaries %}
                                {% set total_new.value = total_new.value + summary.new_categories_generated %}
                            {% endfor %}
                            {{ total_new.value }}
                        {% else %}
                            {% set total_categories = namespace(value=0) %}
                            {% for summary in results.summaries %}
                                {% set total_categories.value = total_categories.value + summary.categories_generated %}
                            {% endfor %}
                            {{ total_categories.value }}
                        {% endif %}
                    </h3>
                    <p class="text-muted mb-0">
                        {% if results.processing_type == 'semi_open_ended' %}
                            New Categories
                        {% else %}
                            Total Categories
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="text-info mb-2">
                        <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                    </div>
                    <h3 class="mb-1">{{ "%.1f"|format(results.duration) }}s</h3>
                    <p class="text-muted mb-0">Processing Time</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="text-warning mb-2">
                        <i class="bi bi-file-earmark-text" style="font-size: 2rem;"></i>
                    </div>
                    <h3 class="mb-1">
                        {% if results.processing_type == 'semi_open_ended' %}
                            {% set total_lainnya = namespace(value=0) %}
                            {% for summary in results.summaries %}
                                {% set total_lainnya.value = total_lainnya.value + summary.lainnya_responses %}
                            {% endfor %}
                            {{ total_lainnya.value }}
                        {% else %}
                            {% set total_classified = namespace(value=0) %}
                            {% for summary in results.summaries %}
                                {% set total_classified.value = total_classified.value + summary.valid_classified %}
                            {% endfor %}
                            {{ total_classified.value }}
                        {% endif %}
                    </h3>
                    <p class="text-muted mb-0">Responses Classified</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Processing Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Processing Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Start Time:</strong> {{ results.start_time }}</p>
                            <p><strong>End Time:</strong> {{ results.end_time }}</p>
                            <p><strong>Duration:</strong> {{ "%.2f"|format(results.duration / 60) }} minutes</p>
                        </div>
                        <div class="col-md-6">
                            {% if results.processing_type == 'semi_open_ended' %}
                                <p><strong>Processing Type:</strong> <span class="badge bg-info">Semi Open-Ended</span></p>
                                <p><strong>Max New Categories:</strong> {{ results.settings.max_categories }}</p>
                                <p><strong>Merged Column:</strong> 
                                    {% if results.settings.create_merged_column %}
                                        <span class="badge bg-success">Created</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Not Created</span>
                                    {% endif %}
                                </p>
                            {% else %}
                                <p><strong>Processing Type:</strong> <span class="badge bg-primary">Pure Open-Ended</span></p>
                                <p><strong>Max Categories:</strong> {{ results.settings.max_categories }}</p>
                                <p><strong>Confidence Threshold:</strong> {{ results.settings.confidence_threshold }}</p>
                                <p><strong>Auto Upload to Kobo:</strong> 
                                    {% if results.settings.auto_upload %}
                                        <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Disabled</span>
                                    {% endif %}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Variable Results -->
    {% for summary in results.summaries %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header {% if summary.type == 'semi_open_ended' %}bg-info text-white{% else %}bg-primary text-white{% endif %}">
                    <h5 class="mb-0">
                        {% if summary.type == 'semi_open_ended' %}
                            <i class="bi bi-list-check"></i> Semi Open-Ended: <code class="text-white">{{ summary.variable }}</code>
                        {% else %}
                            <i class="bi bi-box"></i> Variable: <code class="text-white">{{ summary.variable }}</code>
                        {% endif %}
                    </h5>
                    {% if summary.type == 'semi_open_ended' %}
                        <small>Text Variable: <code class="text-white">{{ summary.text_variable }}</code> | Lainnya Code: {{ summary.lainnya_code }}</small>
                    {% elif summary.question %}
                        <small>{{ summary.question }}</small>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if summary.type == 'semi_open_ended' %}
                        <!-- Semi Open-Ended Statistics -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="border-start border-info border-4 ps-3">
                                    <h4 class="mb-0">{{ summary.lainnya_responses }}</h4>
                                    <small class="text-muted">"Lainnya" Selected</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-start border-success border-4 ps-3">
                                    <h4 class="mb-0">{{ summary.new_categories_generated }}</h4>
                                    <small class="text-muted">New Categories</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-start border-primary border-4 ps-3">
                                    <h4 class="mb-0">{{ summary.pre_coded_categories }}</h4>
                                    <small class="text-muted">Pre-coded Options</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-start border-warning border-4 ps-3">
                                    <h4 class="mb-0">{{ summary.total_categories }}</h4>
                                    <small class="text-muted">Total Categories</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Merged Column Info -->
                        <div class="alert alert-success">
                            <i class="bi bi-diagram-3"></i>
                            <strong>Merged Column Created:</strong> <code>{{ summary.merged_column }}</code><br>
                            <small>This column combines pre-coded options ({{ summary.pre_coded_categories }}) with AI-classified "Lainnya" responses ({{ summary.new_categories_generated }} new categories).</small>
                        </div>
                        
                        <!-- Cost Savings -->
                        <div class="alert alert-info">
                            <i class="bi bi-cash-coin"></i>
                            <strong>Cost Efficiency:</strong> Only {{ summary.lainnya_responses }} responses classified 
                            vs full dataset. <strong>Estimated savings: 70-80%</strong> compared to pure open-ended!
                        </div>
                    {% else %}
                        <!-- Pure Open-Ended Statistics -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="border-start border-primary border-4 ps-3">
                                    <h4 class="mb-0">{{ summary.total_submissions }}</h4>
                                    <small class="text-muted">Total Submissions</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-start border-success border-4 ps-3">
                                    <h4 class="mb-0">{{ summary.valid_classified }}</h4>
                                    <small class="text-muted">Valid Classified</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-start border-warning border-4 ps-3">
                                    <h4 class="mb-0">{{ summary.invalid_text_responses }}</h4>
                                    <small class="text-muted">Invalid (Code 99)</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-start border-secondary border-4 ps-3">
                                    <h4 class="mb-0">{{ summary.empty_responses }}</h4>
                                    <small class="text-muted">Empty/Null</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Category Info -->
                        <div class="alert alert-info">
                            <i class="bi bi-tags"></i>
                            <strong>Categories Generated:</strong> {{ summary.categories_generated }}
                            {% if summary.new_categories_added > 0 %}
                                (+ {{ summary.new_categories_added }} new from outlier analysis)
                            {% endif %}
                            {% if summary.outliers_found > 0 %}
                            | <strong>Outliers Detected:</strong> {{ summary.outliers_found }}
                            {% endif %}
                        </div>
                        
                        <!-- Output Files -->
                        <div class="mt-3">
                            <h6><i class="bi bi-file-earmark-arrow-down"></i> Output Files:</h6>
                            <ul class="list-group">
                                {% for file in summary.output_files %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-file-excel"></i> {{ file.split('/')[-1] }}</span>
                                    <span class="badge bg-success">Ready</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex gap-2 justify-content-between">
                <a href="{{ url_for('main.classify') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> New Classification
                </a>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print Summary
                    </button>
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                        <i class="bi bi-house"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- No Results -->
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>No Results Yet!</strong> Please run a classification first.
    </div>
    
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-bar-chart" style="font-size: 4rem; color: #ccc;"></i>
            <h4 class="mt-3">No Results Yet</h4>
            <p class="text-muted">Start a classification to see results here</p>
            <a href="{{ url_for('main.classify') }}" class="btn btn-primary mt-3">
                <i class="bi bi-play-circle"></i> Start Classification
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
@media print {
    .btn, nav, .sidebar {
        display: none !important;
    }
}
</style>
{% endblock %}
