{% extends "base.html" %}

{% block title %}Dashboard - M-Code Pro{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block page_subtitle %}<i class="bi bi-speedometer2 me-1"></i>Real-time <strong>analytics</strong> and insights{% endblock %}

{% block extra_css %}
<style>
    /* Modern Card Styling */
    .kpi-card {
        border-radius: 16px;
        border: none;
        transition: all 0.3s ease;
        overflow: hidden;
        background: white;
    }
    
    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 28px rgba(0,0,0,0.1);
    }
    
    .kpi-card .card-body {
        padding: 1.75rem;
    }
    
    .kpi-value {
        font-size: 2.25rem;
        font-weight: 700;
        line-height: 1;
        margin: 0.75rem 0;
    }
    
    .kpi-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    .trend-indicator {
        display: inline-flex;
        align-items: center;
        font-size: 0.8rem;
        font-weight: 500;
        margin-top: 0.75rem;
        gap: 0.25rem;
    }
    
    .trend-up {
        color: #198754;
    }
    
    .trend-down {
        color: #dc3545;
    }
    
    .trend-icon {
        font-size: 0.75rem;
    }
    
    .border-accent-primary { border-left: 4px solid #0dcaf0; }
    .border-accent-success { border-left: 4px solid #20c997; }
    .border-accent-info { border-left: 4px solid #0d6efd; }
    .border-accent-warning { border-left: 4px solid #ffc107; }
    
    /* Modern Table */
    .modern-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .modern-table thead th {
        background: transparent;
        border-bottom: 2px solid #e9ecef;
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        padding: 0.875rem 0.75rem;
    }
    
    .modern-table tbody tr {
        transition: all 0.2s ease;
    }
    
    .modern-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .modern-table tbody td {
        padding: 0.875rem 0.75rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f3f5;
        font-size: 0.9rem;
    }
    
    .modern-table tbody td.text-muted {
        font-size: 0.85rem;
    }
    
    .modern-table .badge {
        font-size: 0.75rem;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1.4;
    }
    
    .badge-completed {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    
    .badge-processing {
        background-color: #cfe2ff;
        color: #084298;
    }
    
    .badge-review {
        background-color: #fff3cd;
        color: #664d03;
    }
    
    .btn-icon-only {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        background: white;
        color: #6c757d;
        transition: all 0.2s ease;
    }
    
    .btn-icon-only:hover {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
        transform: scale(1.1);
    }
    
    /* Chart Card */
    .chart-card {
        border-radius: 16px;
        border: none;
        background: white;
    }
    
    .chart-card .card-header {
        background: transparent;
        border-bottom: 1px solid #f1f3f5;
        padding: 1.5rem;
    }
    
    .chart-card .card-body {
        padding: 1.5rem;
    }
    
    /* ============================================
       MOBILE RESPONSIVE (max-width: 768px)
       ============================================ */
    @media (max-width: 768px) {
        /* Container Padding */
        .container-fluid {
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }
        
        /* Header Section */
        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 1rem;
        }
        
        .d-flex.justify-content-between .btn-primary {
            width: 100%;
            justify-content: center;
        }
        
        /* KPI Cards - Full Width Stack */
        .row.g-4 {
            gap: 0.75rem !important;
        }
        
        .kpi-card .card-body {
            padding: 1.25rem;
        }
        
        .kpi-value {
            font-size: 1.75rem;
        }
        
        .kpi-label {
            font-size: 0.7rem;
        }
        
        .trend-indicator {
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        
        /* Chart Cards - Stack Vertically */
        .col-xl-7, .col-xl-5 {
            width: 100% !important;
        }
        
        .chart-card .card-header {
            padding: 1rem;
        }
        
        .chart-card .card-body {
            padding: 1rem;
        }
        
        #performanceChart, #donutChart {
            height: 280px !important;
        }
        
        /* Table - Horizontal Scroll */
        .table-responsive {
            margin: 0 -0.75rem;
            padding: 0 0.75rem;
        }
        
        .modern-table thead th {
            font-size: 0.65rem;
            padding: 0.75rem 0.5rem;
            white-space: nowrap;
        }
        
        .modern-table tbody td {
            padding: 0.75rem 0.5rem;
            font-size: 0.85rem;
        }
        
        .modern-table tbody td:first-child {
            min-width: 200px;
        }
        
        .modern-table tbody td:first-child .fw-semibold {
            font-size: 0.85rem;
        }
        
        .modern-table tbody td:first-child small {
            font-size: 0.75rem;
        }
        
        .status-badge {
            font-size: 0.7rem;
            padding: 3px 10px;
        }
        
        .btn-icon-only {
            width: 30px;
            height: 30px;
        }
        
        /* Recent Projects Card */
        .chart-card .card-header .d-flex {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start !important;
        }
        
        .chart-card .card-header .btn-sm {
            width: 100%;
            justify-content: center;
        }
    }
    
    /* Small Mobile (max-width: 576px) */
    @media (max-width: 576px) {
        .kpi-value {
            font-size: 1.5rem;
        }
        
        .kpi-label {
            font-size: 0.65rem;
        }
        
        h1.h3 {
            font-size: 1.25rem !important;
        }
        
        #performanceChart, #donutChart {
            height: 250px !important;
        }
        
        .modern-table tbody td:first-child {
            min-width: 180px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding-top: 15px;">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 fw-bold">Analytics Overview</h1>
            <p class="text-muted mb-0 d-none d-md-block" style="font-size: 0.9rem;">Monitor your classification performance and insights</p>
        </div>
        <a href="{{ url_for('main.classify') }}" class="btn btn-primary px-4 d-flex align-items-center justify-content-center">
            <i class="bi bi-plus-circle me-2"></i>
            <span class="d-none d-sm-inline">New Classification</span>
            <span class="d-inline d-sm-none">New</span>
        </a>
    </div>

    <!-- KPI Cards -->
    <div class="row g-4 mb-4">
        <!-- Total Classifications -->
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card shadow-sm border-accent-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="kpi-label">Total Classifications</div>
                            <div class="kpi-value text-dark">{{ "{:,}".format(total_classifications) }}</div>
                            {% if classifications_trend >= 0 %}
                            <div class="trend-indicator trend-up">
                                <span class="trend-icon">â–²</span>
                                <span>{{ classifications_trend }}% last week</span>
                            </div>
                            {% else %}
                            <div class="trend-indicator trend-down">
                                <span class="trend-icon">â–¼</span>
                                <span>{{ classifications_trend|abs }}% last week</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <i class="bi bi-clipboard-data" style="font-size: 2.5rem; color: #0dcaf0; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Processed -->
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card shadow-sm border-accent-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="kpi-label">Responses Classified</div>
                            <div class="kpi-value text-dark">{{ "{:,}".format(total_responses) }}</div>
                            {% if responses_trend >= 0 %}
                            <div class="trend-indicator trend-up">
                                <span class="trend-icon">â–²</span>
                                <span>{{ responses_trend }}% last week</span>
                            </div>
                            {% else %}
                            <div class="trend-indicator trend-down">
                                <span class="trend-icon">â–¼</span>
                                <span>{{ responses_trend|abs }}% last week</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <i class="bi bi-database-check" style="font-size: 2.5rem; color: #20c997; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Avg. Confidence -->
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card shadow-sm border-accent-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="kpi-label">Active Jobs</div>
                            <div class="kpi-value text-dark">{{ active_jobs_count }}</div>
                            <div class="trend-indicator" style="color: #6c757d;">
                                <span class="trend-icon">âš¡</span>
                                <span>Processing now</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <i class="bi bi-check-circle-fill" style="font-size: 2.5rem; color: #0d6efd; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Needs Review (Low Confidence) -->
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card shadow-sm border-accent-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="kpi-label">Total Variables</div>
                            <div class="kpi-value text-dark">{{ total_variables }}</div>
                            <div class="trend-indicator" style="color: #6c757d;">
                                <span class="trend-icon">ðŸ“Š</span>
                                <span>All time
                            </div>
                        </div>
                        <div class="text-end">
                            <i class="bi bi-exclamation-triangle" style="font-size: 2.5rem; color: #ffc107; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Middle Section: Charts -->
    <div class="row g-4 mb-4">
        <!-- Main Chart: Classification Performance Trend -->
        <div class="col-xl-7 col-lg-6">
            <div class="chart-card shadow-sm">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold" d-none d-md-block">Monthly classification volume over time</small>
                        </div>
                        <div class="dropdown d-none d-lg-block
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Last 12 Months
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Last 6 Months</a></li>
                                <li><a class="dropdown-item" href="#">Last 12 Months</a></li>
                                <li><a class="dropdown-item" href="#">This Year</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="performanceChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>

        <!-- Donut Chart: Sentiment Analysis -->
        <div class="col-xl-5 col-lg-6">
            <div class="chart-card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0 fw-bold">Top Categories Distribution</h6>
                    <small class="text-muted d-none d-md-block">Most frequent classification categories</small>
                </div>
                <div class="card-body text-center">
                    <div id="donutChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Section: Recent Projects -->
    <div class="row">
        <div class="col-12">
            <div class="chart-card shadow-sm">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold">Recent Projects</h6>
                            <small class="text-muted d-none d-md-block">Latest classification activities</small>
                        </div>
                        <a href="{{ url_for('main.jobs') }}" class="btn btn-sm btn-outline-primary d-flex align-items-center">
                            <span class="d-none d-sm-inline">View All</span>
                            <span class="d-inline d-sm-none">All</span>
                            <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table modern-table mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Project Name</th>
                                    <th style="width: 15%;">Upload Date</th>
                                    <th style="width: 15%;">Variables</th>
                                    <th style="width: 15%;">Status</th>
                                    <th style="width: 15%;" class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if recent_jobs %}
                                    {% for job in recent_jobs %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-file-earmark-spreadsheet text-primary me-2" style="font-size: 1.5rem;"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ job.original_filename|truncate(50, True) }}</div>
                                                    <small class="text-muted">{{ "{:,}".format(job.total_responses or 0) }} responses</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-muted">{{ job.created_at.strftime('%b %d, %Y') }}</td>
                                        <td><span class="badge bg-light text-dark">{{ job.total_variables or 0 }} vars</span></td>
                                        <td>
                                            {% if job.status == 'completed' %}
                                            <span class="status-badge badge-completed">Completed</span>
                                            {% elif job.status == 'processing' %}
                                            <span class="status-badge badge-processing">Processing</span>
                                            {% elif job.status == 'failed' %}
                                            <span class="status-badge badge-failed">Failed</span>
                                            {% else %}
                                            <span class="status-badge badge-pending">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if job.status == 'completed' %}
                                            <a href="{{ url_for('main.view_result', job_id=job.job_id) }}" class="btn btn-sm btn-outline-primary" title="View Results">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% elif job.status == 'processing' %}
                                            <a href="{{ url_for('main.classification_progress', job_id=job.job_id) }}" class="btn btn-sm btn-outline-info" title="Monitor">
                                                <i class="bi bi-activity"></i>
                                            </a>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-5">
                                            <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.2;"></i>
                                            <p class="mb-0 mt-3 fw-semibold">No classification jobs yet</p>
                                            <p class="text-muted small mb-3">Start your first classification to see data here</p>
                                            <a href="{{ url_for('main.classify') }}" class="btn btn-primary btn-sm">
                                                <i class="bi bi-plus-circle me-1"></i> New Classification
                                            </a>
                                        </td>
                                    </tr>
                                {% endif %}
                                    <td><span class="status-badge badge-completed">Completed</span></td>
                                    <td class="text-center" style="width: 80px;">
                                        <a href="{{ url_for('main.jobs') }}" class="btn-icon-only">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-earmark-spreadsheet text-primary me-2" style="font-size: 1.5rem;"></i>
                                            <div>
                                                <div class="fw-semibold">Brand Perception Study - Telco</div>
                                                <small class="text-muted">8,921 responses</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">Jan 09, 2026</td>
                                    <td><span class="badge bg-light text-dark">8 vars</span></td>
                                    <td><span class="status-badge badge-completed">Completed</span></td>
                                    <td class="text-center" style="width: 80px;">
                                        <a href="{{ url_for('main.jobs') }}" class="btn-icon-only">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-earmark-spreadsheet text-primary me-2" style="font-size: 1.5rem;"></i>
                                            <div>
                                                <div class="fw-semibold">Employee Engagement Survey 2026</div>
                                                <small class="text-muted">3,456 responses</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">Jan 08, 2026</td>
                                    <td><span class="badge bg-light text-dark">15 vars</span></td>
                                    <td><span class="status-badge badge-processing">Processing</span></td>
                                    <td class="text-center" style="width: 80px;">
                                        <a href="{{ url_for('main.jobs') }}" class="btn-icon-only">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-earmark-spreadsheet text-primary me-2" style="font-size: 1.5rem;"></i>
                                            <div>
                                                <div class="fw-semibold">Market Research - FMCG Products</div>
                                                <small class="text-muted">12,789 responses</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">Jan 10, 2026</td>
                                    <td><span class="badge bg-light text-dark">12 vars</span></td>
                                    <td><span class="status-badge badge-completed">Completed</span></td>
                                    <td class="text-center" style="width: 80px;">
                                        <a href="{{ url_for('main.jobs') }}" class="btn-icon-only">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-earmark-spreadsheet text-primary me-2" style="font-size: 1.5rem;"></i>
                                            <div>
                                                <div class="fw-semibold">NPS Survey - Banking Sector</div>
                                                <small class="text-muted">6,543 responses</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">Jan 08, 2026</td>
                                    <td><span class="badge bg-light text-dark">15 vars</span></td>
                                    <td><span class="status-badge badge-processing">Processing</span></td>
                                    <td class="text-center" style="width: 80px;">
                                        <a href="{{ url_for('main.jobs') }}" class="btn-icon-only">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    // ============================================
    // Area Chart: Classification Performance Trend
    // ============================================
    var performanceOptions = {
        series: [{
            name: 'Classifications',
            data: {{ chart_data|tojson }}
        }],
        chart: {
            type: 'area',
            height: 350,
            toolbar: {
                show: false
            },
            zoom: {
                enabled: false
            }
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth',
            width: 3,
            colors: ['#0dcaf0']
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.5,
                opacityTo: 0.05,
                stops: [0, 90, 100],
                colorStops: [
                    {
                        offset: 0,
                        color: '#0dcaf0',
                        opacity: 0.5
                    },
                    {
                        offset: 100,
                        color: '#0dcaf0',
                        opacity: 0.05
                    }
                ]
            }
        },
        xaxis: {
            categories: {{ chart_labels|tojson }},
            labels: {
                style: {
                    colors: '#6c757d',
                    fontSize: '12px'
                }
            },
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#6c757d',
                    fontSize: '12px'
                },
                formatter: function(val) {
                    return val.toLocaleString();
                }
            }
        },
        grid: {
            borderColor: '#f1f3f5',
            strokeDashArray: 4,
            xaxis: {
                lines: {
                    show: false
                }
            }
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function(val) {
                    return val.toLocaleString() + ' classifications';
                }
            }
        }
    };

    var performanceChart = new ApexCharts(document.querySelector("#performanceChart"), performanceOptions);
    performanceChart.render();

    // ============================================
    // Donut Chart: Top Categories Distribution
    // ============================================
    var donutOptions = {
        series: [{{ pure_count }}, {{ semi_count }}],
        chart: {
            type: 'donut',
            height: 350
        },
        labels: ['Pure Open-Ended', 'Semi Open-Ended'],
        colors: ['#0dcaf0', '#20c997', '#0d6efd', '#6f42c1', '#ffc107'],
        dataLabels: {
            enabled: false
        },
        legend: {
            show: true,
            position: 'bottom',
            fontSize: '12px',
            fontWeight: 500,
            fontFamily: 'inherit',
            labels: {
                colors: ['#6c757d']
            },
            markers: {
                width: 10,
                height: 10,
                radius: 2
            },
            itemMargin: {
                horizontal: 10,
                vertical: 6
            },
            formatter: function(seriesName, opts) {
                return seriesName + ': ' + opts.w.globals.series[opts.seriesIndex].toLocaleString();
            }
        },
        plotOptions: {
            pie: {
                donut: {
                    size: '70%',
                    labels: {
                        show: true,
                        name: {
                            show: true,
                            fontSize: '14px',
                            fontWeight: 600,
                            color: '#6c757d'
                        },
                        value: {
                            show: true,
                            fontSize: '28px',
                            fontWeight: 700,
                            color: '#212529',
                            formatter: function(val) {
                                return parseFloat(val).toLocaleString();
                            }
                        },
                        total: {
                            show: true,
                            label: 'Total',
                            fontSize: '14px',
                            fontWeight: 600,
                            color: '#6c757d',
                            formatter: function(w) {
                                return w.globals.seriesTotals.reduce((a, b) => a + b, 0).toLocaleString();
                            }
                        }
                    }
                }
            }
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function(val) {
                    return val.toLocaleString() + ' responses';
                }
            }
        }
    };

    var donutChart = new ApexCharts(document.querySelector("#donutChart"), donutOptions);
    donutChart.render();
</script>
{% endblock %}
